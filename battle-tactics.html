<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Tactics Talent Tree</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      background:linear-gradient(135deg,#1a2333,#2d3748);
      color:#fff;
      font-family:Arial, sans-serif;
      min-height:100vh;
      overflow-x:auto;
      /* header (56) + points bar (44) */
      padding-top:100px;
      padding-bottom:80px;
    }

    /* ===== HEADER ===== */
    .header{
      position:fixed;top:0;left:0;right:0;height:56px;
      display:grid;grid-template-columns:56px 1fr 56px;
      align-items:center;background:#0b0b0b;
      border-bottom:2px solid #C89B3C;z-index:1000
    }
    .back-button,.info-button{
      background:none;border:0;color:#fff;font-size:20px;
      width:56px;height:56px;cursor:pointer
    }
    .back-button:hover,.info-button:hover{background:rgba(255,255,255,.06);border-radius:4px}
    .header-title{
      grid-column:2;text-align:center;margin:0;
      font-family:'Cormorant Garamond',serif;
      font-weight:400;font-size:28px;letter-spacing:.3px;color:#fff;
      text-shadow:0 1px 0 rgba(0,0,0,.4)
    }

    /* ===== POINTS BAR ===== */
    .points-bar{
      position:fixed;top:56px;left:0;right:0;height:44px;
      background:#0f3c55;border-bottom:2px solid #C89B3C;
      display:flex;align-items:center;justify-content:center;gap:10px;z-index:900
    }
    .points-emblem{font-size:18px;filter:drop-shadow(0 1px 0 rgba(0,0,0,.4));opacity:.9}
    .points-bar #pointsText{color:#ffd777;font-weight:700;font-size:16px}

    .tree-container{
      padding:20px;display:flex;justify-content:center;align-items:flex-start;
      min-height:calc(100vh - 150px);width:100%;overflow-x:auto
    }
    .talent-tree{display:flex;flex-direction:column;align-items:center;gap:20px;position:relative;margin:0 auto}
    .talent-row{display:flex;align-items:center;justify-content:center;gap:30px;position:relative;min-height:340px}

    .talent-card{
      background:linear-gradient(135deg,#4a5568,#2d3748);
      border:3px solid #718096;border-radius:15px;padding:20px;width:220px;height:310px;position:relative;user-select:none;z-index:10
    }
    .talent-card.unlocked{border-color:#C89B3C;background:linear-gradient(135deg,#8B4513,#CD853F);box-shadow:0 0 15px rgba(200,155,60,.5)}
    .talent-card.locked{opacity:.5;border-color:#4a5568}
    .talent-card:hover:not(.locked){transform:translateY(-5px);box-shadow:0 8px 25px rgba(200,155,60,.3)}

    .talent-icon{width:60px;height:60px;background:linear-gradient(45deg,#4a5568,#718096);border:2px solid #C89B3C;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin:0 auto 15px}
    .talent-name{font-weight:bold;text-align:center;font-size:1rem;line-height:1.3;height:50px;display:flex;align-items:center;justify-content:center;margin-bottom:15px;padding:0 5px}

    .controls-grid{width:140px;margin:0 auto 20px}
    .controls-row{display:flex;gap:8px;margin-bottom:8px}
    .control-btn{flex:1;height:40px;border:2px solid #C89B3C;border-radius:6px;color:#fff;font-size:1rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .control-btn:hover:not(:disabled){transform:translateY(-1px)}
    .control-btn:disabled{opacity:.3;cursor:not-allowed;background:#444!important;border-color:#666!important;transform:none}
    .remove-btn{background:linear-gradient(135deg,#f1c40f,#f39c12)}
    .remove-btn:hover:not(:disabled){background:linear-gradient(135deg,#f39c12,#f1c40f)}
    .add-btn{background:linear-gradient(135deg,#3498db,#2980b9)}
    .add-btn:hover:not(:disabled){background:linear-gradient(135deg,#2980b9,#3498db)}

    .talent-points{
      background:rgba(0,0,0,.9);border:2px solid #C89B3C;border-radius:12px;
      padding:6px 12px;font-weight:bold;color:#C89B3C;font-size:1.1rem;text-align:center;
      position:absolute;bottom:8px;left:50%;transform:translateX(-50%)
    }

    .connection-line{position:absolute;background:#718096;z-index:1;transition:all .3s ease}
    .connection-line.active{background:#C89B3C;box-shadow:0 0 10px rgba(200,155,60,.5)}
    .vertical-line{width:3px;height:40px;top:-40px;left:50%;transform:translateX(-50%)}
    .horizontal-line{height:3px;width:50px;top:50%;transform:translateY(-50%);left:-50px}

    .footer{
      position:fixed;bottom:0;left:0;right:0;background:#000;height:70px;
      display:flex;align-items:center;justify-content:center;z-index:1000;border-top:2px solid #C89B3C
    }
    .reset-button{
      background:linear-gradient(135deg,#842800,#7f2a01);border:2px solid #C89B3C;color:#fff;
      padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:1.1rem;transition:all .3s ease;
      font-family:'Cormorant Garamond',serif
    }
    .reset-button:hover{background:linear-gradient(135deg,#c53030,#e53e3e);transform:translateY(-2px)}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:2000;justify-content:center;align-items:center}
    .modal-content{background:linear-gradient(135deg,#2d3748,#1a2333);border:2px solid #C89B3C;border-radius:15px;padding:30px;max-width:400px;width:90%;text-align:center}
    .modal-title{font-family:'Cormorant Garamond',serif;font-weight:600;font-size:1.5rem;color:#C89B3C;margin-bottom:20px}
    .modal-button{background:linear-gradient(135deg,#8B4513,#CD853F);border:2px solid #C89B3C;color:#fff;padding:10px 20px;margin:10px 5px;border-radius:8px;cursor:pointer;font-weight:bold;width:100%;transition:all .3s ease}
    .modal-button:hover{background:linear-gradient(135deg,#CD853F,#8B4513);transform:translateY(-2px)}
    .close-button{background:linear-gradient(135deg,#666,#444);margin-top:20px}
    .close-button:hover{background:linear-gradient(135deg,#444,#666)}
    .control-info{text-align:left;margin:20px 0;font-size:.9rem;color:#a0aec0}

    /* Mobile tweaks */
    @media (max-width:768px){
      .header-title{font-size:22px}
      .talent-card{width:200px;height:300px;padding:15px}
      .talent-name{font-size:.9rem;height:45px;margin-bottom:12px}
      .controls-grid{width:130px;margin:0 auto 18px}
      .control-btn{height:36px;font-size:.9rem}
      .talent-row{gap:20px;flex-wrap:wrap;justify-content:center}
      .tree-container{padding:15px 10px}
    }
    @media (max-width:480px){
      .header-title{font-size:20px}
      .talent-card{width:180px;height:280px;padding:12px}
      .talent-name{font-size:.8rem;height:40px}
      .controls-grid{width:120px}
      .control-btn{height:32px;font-size:.8rem}
      .talent-points{font-size:1rem;padding:4px 8px;bottom:6px}
      .talent-row{gap:15px}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <button class="back-button" onclick="returnToHub()">‚Üê</button>
    <h1 class="header-title">Battle Tactics</h1>
    <button class="info-button" onclick="openModal()">‚ìò</button>
  </div>

  <!-- Points bar -->
  <div class="points-bar">
    <span class="points-emblem">üõ°Ô∏è</span>
    <span id="pointsText">0</span>
  </div>

  <!-- Tree -->
  <div class="tree-container">
    <div class="talent-tree" id="talentTree"></div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <button class="reset-button" onclick="resetAllTalents()">Reset Battle Tactics Talents</button>
  </div>

  <!-- Modal -->
  <div class="modal" id="infoModal">
    <div class="modal-content">
      <h3 class="modal-title">Controls</h3>
      <button class="modal-button" onclick="exportBuild()">üìã Export Build</button>
      <button class="modal-button" onclick="importBuild()">üì• Import Build</button>
      <div class="control-info">
        <strong>Button Controls:</strong><br>
        ‚Ä¢ <strong>+</strong>: Add 1 point<br>
        ‚Ä¢ <strong>-</strong>: Remove 1 point<br>
        ‚Ä¢ <strong>&gt;&gt;</strong>: Add to maximum<br>
        ‚Ä¢ <strong>&lt;&lt;</strong>: Remove all points<br>
        ‚Ä¢ Must have ‚â•1 point in prerequisite
      </div>
      <button class="modal-button close-button" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    // --- Battle Tactics data ---
    const talentData = [
      // Row 1
      [{ id:'guards_train_1', name:"Guardsmen's Training Speed I", maxPoints:20, icon:'‚öîÔ∏è', prerequisites:[] }],
      // Row 2
      [
        { id:'spec_train_1', name:"Specialists' Training Speed I", maxPoints:20, icon:'üõ°Ô∏è', prerequisites:['guards_train_1'] },
        { id:'spec_march_1', name:"Specialists' March Speed I", maxPoints:20, icon:'üèÉ', prerequisites:['spec_train_1'] },
        { id:'spec_health_1', name:"Specialists' Health I", maxPoints:20, icon:'‚ù§Ô∏è', prerequisites:['spec_march_1'] }
      ],
      // Row 3
      [
        { id:'monster_train_1', name:"Monsters' Training Speed I", maxPoints:20, icon:'üëπ', prerequisites:['spec_train_1'] },
        { id:'monster_march_1', name:"Monsters' March Speed I", maxPoints:20, icon:'ü¶∂', prerequisites:['monster_train_1'] },
        { id:'monster_health_1', name:"Monsters' Health I", maxPoints:20, icon:'üí™', prerequisites:['monster_march_1'] }
      ],
      // Row 4
      [
        { id:'siege_train_1', name:"Siege Engines' Training Speed I", maxPoints:20, icon:'üèóÔ∏è', prerequisites:['monster_train_1'] },
        { id:'siege_march_1', name:"Siege Engines' March Speed I", maxPoints:20, icon:'‚öôÔ∏è', prerequisites:['siege_train_1'] },
        { id:'eng_health_1', name:"Engineer Corps' Health I", maxPoints:20, icon:'üîß', prerequisites:['siege_march_1'] }
      ],
      // Row 5
      [{ id:'guards_march_1', name:"Guardsmen's March Speed I", maxPoints:20, icon:'üö∂', prerequisites:['siege_train_1'] }],
      // Row 6
      [
        { id:'guards_health_1', name:"Guardsmen's Health I", maxPoints:20, icon:'‚ù§Ô∏è', prerequisites:['guards_march_1'] },
        { id:'army_carry_1', name:"Army Carrying Capacity I", maxPoints:20, icon:'üéí', prerequisites:['guards_health_1'] }
      ],
      // Row 7
      [
        { id:'guards_str_1', name:"Guardsmen's Strength I", maxPoints:20, icon:'üí™', prerequisites:['guards_health_1'] },
        { id:'guards_double_1', name:"Chance for Guardsmen Double Damage I", maxPoints:1, icon:'‚ö°', prerequisites:['guards_str_1'] }
      ],
      // Row 8
      [
        { id:'spec_str_1', name:"Specialists' Strength I", maxPoints:20, icon:'üó°Ô∏è', prerequisites:['guards_str_1'] },
        { id:'spec_double_1', name:"Chance for Specialists Double Damage I", maxPoints:1, icon:'‚ö°', prerequisites:['spec_str_1'] }
      ],
      // Row 9
      [
        { id:'eng_str_1', name:"Engineer Corps' Strength I", maxPoints:20, icon:'üî®', prerequisites:['spec_str_1'] },
        { id:'eng_double_1', name:"Chance for Engineer Corps Double Damage I", maxPoints:1, icon:'‚ö°', prerequisites:['eng_str_1'] }
      ],
      // Row 10
      [
        { id:'monster_str_1', name:"Monsters' Strength I", maxPoints:20, icon:'üëø', prerequisites:['eng_str_1'] },
        { id:'monster_double_1', name:"Chance for Monsters Double Damage I", maxPoints:1, icon:'‚ö°', prerequisites:['monster_str_1'] }
      ]
    ];

    // --- State ---
    let talentPoints = {};
    let totalAvailablePoints = 100;

    function initializeTalents(){
      talentData.flat().forEach(t=>{talentPoints[t.id]=0;});
    }

    // Hub integration
    function loadFromHub(){
      try{
        const hubData = localStorage.getItem('totalBattleTalentHub');
        if(hubData){
          const data = JSON.parse(hubData);
          totalAvailablePoints = data.totalPoints || 100;
          if(data.treeBuilds && data.treeBuilds.battle){
            Object.keys(data.treeBuilds.battle).forEach(id=>{
              if(talentPoints.hasOwnProperty(id)){talentPoints[id]=data.treeBuilds.battle[id];}
            });
          }
        }
      }catch(e){ console.error('Error loading hub data:', e); }
    }

    function saveToHub(){
      try{
        let hubData = localStorage.getItem('totalBattleTalentHub');
        let data = hubData ? JSON.parse(hubData) : {
          totalPoints:100,
          allocatedPoints:{battle:0,expert:0,economy:0,archaeology:0},
          treeBuilds:{battle:{},expert:{},economy:{},archaeology:{}}
        };
        data.treeBuilds.battle = {...talentPoints};
        data.allocatedPoints.battle = Object.values(talentPoints).reduce((a,b)=>a+b,0);
        localStorage.setItem('totalBattleTalentHub', JSON.stringify(data));
      }catch(e){ console.error('Error saving to hub:', e); }
    }

    function getRemainingPoints(){
      try{
        const hubData = localStorage.getItem('totalBattleTalentHub');
        if(hubData){
          const data = JSON.parse(hubData);
          const totalAllocated = Object.values(data.allocatedPoints||{}).reduce((a,b)=>a+b,0);
          return data.totalPoints - totalAllocated;
        }
      }catch(e){ console.error('Error calculating remaining points:', e); }
      return totalAvailablePoints - Object.values(talentPoints).reduce((a,b)=>a+b,0);
    }

    // Talents
    function isTalentUnlocked(t){
      if(!t.prerequisites || t.prerequisites.length===0) return true;
      return t.prerequisites.some(id => (talentPoints[id]||0) > 0);
    }

    function addOne(id){
      const t = talentData.flat().find(x=>x.id===id);
      if(!t || !isTalentUnlocked(t)) return;
      const remaining = getRemainingPoints();
      if(talentPoints[id] < t.maxPoints && remaining>0){
        talentPoints[id]++; saveToHub(); updateDisplay();
      }
    }

    function removeOne(id){
      if(talentPoints[id] > 0){
        const dependents = talentData.flat().filter(t => t.prerequisites.includes(id) && talentPoints[t.id]>0);
        if(dependents.length>0 && talentPoints[id]===1){
          alert("Cannot remove last point - other talents depend on this one!"); return;
        }
        talentPoints[id]--; saveToHub(); updateDisplay();
      }
    }

    function addToMax(id){
      const t = talentData.flat().find(x=>x.id===id);
      if(!t || !isTalentUnlocked(t)) return;
      const remaining = getRemainingPoints();
      const need = t.maxPoints - talentPoints[id];
      const canAdd = Math.min(need, remaining);
      if(canAdd>0){ talentPoints[id]+=canAdd; saveToHub(); updateDisplay(); }
    }

    function removeAll(id){
      if(talentPoints[id]>0){
        const dependents = talentData.flat().filter(t => t.prerequisites.includes(id) && talentPoints[t.id]>0);
        if(dependents.length>0){ alert("Cannot remove all points - other talents depend on this one!"); return; }
        talentPoints[id]=0; saveToHub(); updateDisplay();
      }
    }

    // UI
    function createTalentCard(t){
      const card=document.createElement('div'); card.className='talent-card';
      const isUnlocked = isTalentUnlocked(t);
      const remaining = getRemainingPoints();
      const current = talentPoints[t.id];

      if(isUnlocked) card.classList.add('unlocked'); else card.classList.add('locked');

      const canAddOne = isUnlocked && current<t.maxPoints && remaining>0;
      const canRemoveOne = current>0;
      const canAddMax = isUnlocked && current<t.maxPoints && remaining>0;
      const canRemoveAll = current>0;

      card.innerHTML = `
        <div class="talent-icon">${t.icon}</div>
        <div class="talent-name">${t.name}</div>
        <div class="controls-grid">
          <div class="controls-row">
            <button class="control-btn remove-btn" onclick="removeOne('${t.id}')" ${!canRemoveOne?'disabled':''}>-</button>
            <button class="control-btn add-btn" onclick="addOne('${t.id}')" ${!canAddOne?'disabled':''}>+</button>
          </div>
          <div class="controls-row">
            <button class="control-btn remove-btn" onclick="removeAll('${t.id}')" ${!canRemoveAll?'disabled':''}>&lt;&lt;</button>
            <button class="control-btn add-btn" onclick="addToMax('${t.id}')" ${!canAddMax?'disabled':''}>&gt;&gt;</button>
          </div>
        </div>
        <div class="talent-points">${current}/${t.maxPoints}</div>
      `;

      return card;
    }

    function renderTalentTree(){
      const container=document.getElementById('talentTree');
      container.innerHTML='';
      talentData.forEach((row,rowIndex)=>{
        const rowDiv=document.createElement('div'); rowDiv.className='talent-row';
        row.forEach((t,colIndex)=>{
          const card=createTalentCard(t); rowDiv.appendChild(card);

          if(rowIndex>0 && t.prerequisites.length>0){
            const v=document.createElement('div'); v.className='connection-line vertical-line';
            if(talentPoints[t.id]>0 || t.prerequisites.some(p=>talentPoints[p]>0)){ v.classList.add('active'); }
            card.appendChild(v);
          }
          if(colIndex>0){
            const h=document.createElement('div'); h.className='connection-line horizontal-line';
            if(talentPoints[t.id]>0 || talentPoints[row[colIndex-1].id]>0){ h.classList.add('active'); }
            card.appendChild(h);
          }
        });
        container.appendChild(rowDiv);
      });
    }

    function updateDisplay(){
      const remaining=getRemainingPoints();
      document.getElementById('pointsText').textContent = remaining;
      renderTalentTree();
    }

    // Modal
    function openModal(){ document.getElementById('infoModal').style.display='flex'; }
    function closeModal(){ document.getElementById('infoModal').style.display='none'; }
    window.onclick = e => { const m=document.getElementById('infoModal'); if(e.target===m) closeModal(); };

    // Nav
    function returnToHub(){ saveToHub(); window.location.href='index.html'; }
    function resetAllTalents(){
      if(confirm('Are you sure you want to reset the Battle Tactics talent tree?')){
        initializeTalents(); saveToHub(); updateDisplay();
      }
    }
    function exportBuild(){
      const build = JSON.stringify({ totalPoints: totalAvailablePoints, talents: talentPoints });
      navigator.clipboard.writeText(build).then(()=>{ alert('Build copied to clipboard!'); closeModal(); });
    }
    function importBuild(){
      const input = prompt('Paste your build data here:');
      if(input){
        try{
          const build = JSON.parse(input);
          talentPoints = build.talents; saveToHub(); updateDisplay();
          alert('Build imported successfully!'); closeModal();
        }catch(e){ alert('Invalid build data!'); }
      }
    }

    // Init
    initializeTalents();
    loadFromHub();
    updateDisplay();
  </script>
</body>
</html>
